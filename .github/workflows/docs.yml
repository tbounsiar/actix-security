name: Deploy Documentation

on:
  push:
    branches: [main, master]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install mdBook
        run: |
          mkdir -p $HOME/.local/bin
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz -C $HOME/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Extract major.minor from tag (e.g., v0.2.0 -> 0.2)
            VERSION=$(echo "${GITHUB_REF#refs/tags/v}" | cut -d. -f1,2)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            # Development version from master branch
            echo "version=next" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi
          echo "Building docs for version: $VERSION"

      - name: Build mdBook documentation
        run: |
          cd docs
          mdbook build

      - name: Build API documentation
        run: |
          cargo doc --workspace --all-features --no-deps
          cp -r target/doc docs/book/api
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=actix_security/index.html"></head></html>' > docs/book/api/index.html
        env:
          RUSTDOCFLAGS: --cfg docsrs

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Prepare versioned deployment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IS_RELEASE="${{ steps.version.outputs.is_release }}"

          # Create gh-pages directory if it doesn't exist
          mkdir -p gh-pages

          # Copy new docs to versioned directory
          rm -rf "gh-pages/$VERSION"
          cp -r docs/book "gh-pages/$VERSION"

          # Generate versions.json (include next and all semver versions)
          cd gh-pages
          VERSIONS=$(ls -d */ 2>/dev/null | grep -E '^[0-9]+\.[0-9]+/$|^next/$' | sed 's/\///' | sort -rV)
          echo "[" > versions.json
          FIRST=true
          for v in $VERSIONS; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              echo "," >> versions.json
            fi
            echo "  \"$v\"" >> versions.json
          done
          echo "]" >> versions.json
          cat versions.json

          # Determine the latest stable version (highest semver, excluding "next")
          LATEST_STABLE=$(ls -d */ 2>/dev/null | grep -E '^[0-9]+\.[0-9]+/$' | sed 's/\///' | sort -rV | head -n1)

          # If this is a release, update the root redirect to point to this version
          # Otherwise, only create/update root index.html if it doesn't exist or if there's a new stable version
          if [ "$IS_RELEASE" = "true" ]; then
            REDIRECT_TARGET="$VERSION"
            echo "Release build: redirecting to $REDIRECT_TARGET"
          elif [ -n "$LATEST_STABLE" ]; then
            REDIRECT_TARGET="$LATEST_STABLE"
            echo "Development build: redirecting to latest stable $REDIRECT_TARGET"
          else
            REDIRECT_TARGET="next"
            echo "No stable release yet: redirecting to next"
          fi

          # Create root index.html that redirects to the appropriate version
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Actix Security Documentation</title>
            <meta http-equiv="refresh" content="0; url=$REDIRECT_TARGET/">
            <link rel="canonical" href="$REDIRECT_TARGET/">
          </head>
          <body>
            <p>Redirecting to <a href="$REDIRECT_TARGET/">$REDIRECT_TARGET documentation</a>...</p>
          </body>
          </html>
          EOF

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: false

  pages:
    name: Configure GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
